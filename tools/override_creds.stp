#!/usr/bin/env stap

probe kernel.function("override_creds") {
  mnt_ns = @cast(task_current(), "struct task_struct")->nsproxy->mnt_ns
  inum = @cast(mnt_ns, "struct mnt_namespace")->ns->inum

  if (inum == 4026533472) {
    printf("-----------------------\n")
    printf("new: 0x%x\n", $new)
    cred = @cast(task_current(), "struct task_struct")->cred
    effective0 = @cast(cred, "struct cred")->cap_effective->cap[0]
    effective1 = @cast(cred, "struct cred")->cap_effective->cap[1]
    printf("current cap_effective: 0x%x%x\n", effective1, effective0)

    effective0 = @cast($new, "struct cred")->cap_effective->cap[0]
    effective1 = @cast($new, "struct cred")->cap_effective->cap[1]
    printf("new cap_effective: 0x%x%x\n", effective1, effective0)
    print_backtrace()
  }
}